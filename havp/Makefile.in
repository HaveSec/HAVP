CXX = @CXX@
CFLAGS = @CFLAGS@
LDFLAGS = @LDFLAGS@
DEFINES = @DEFS@
INSTALL = ../install-sh

prefix = @prefix@
etcdir = @prefix@/etc/havp

OBJECTS = helper.o logfile.o scannerhandler.o connectiontobrowser.o \
          genericscanner.o httphandler.o params.o sockethandler.o \
          connectiontohttp.o havp.o proxyhandler.o utils.o whitelist.o

all: havp

havp: $(OBJECTS)
	cd scanners && $(MAKE)
	$(CXX) $(CFLAGS) -o havp $(OBJECTS) scanners/scanners.a $(LDFLAGS)

%.o: %.cpp %.h default.h
	$(CXX) $(CFLAGS) $(DEFINES) -c -o $@ $<

install: all
	$(INSTALL) -m 755 -d $(prefix)/sbin
	$(INSTALL) -m 755 -d $(etcdir)
	$(INSTALL) -s -m 755 havp $(prefix)/sbin/havp
	$(INSTALL) -m 644 ../etc/havp/havp.config $(etcdir)/havp.config.default
	if [ ! -f $(etcdir)/havp.config ]; then \
		$(INSTALL) -m 644 ../etc/havp/havp.config $(etcdir)/havp.config; \
	else \
		../update-conf $(etcdir)/havp.config; \
	fi
	if [ ! -f $(etcdir)/whitelist ]; then \
		$(INSTALL) -m 644 ../etc/havp/whitelist $(etcdir)/whitelist; \
	fi
	if [ ! -f $(etcdir)/blacklist ]; then \
		$(INSTALL) -m 644 ../etc/havp/blacklist $(etcdir)/blacklist; \
	fi
	cp -r ../etc/havp/templates $(etcdir)
	chmod -R a+rX $(etcdir)/templates

	@echo ""
	@echo "HAVP installed - see documentation for needed extra steps"
	@echo ""

clean:
	cd scanners && $(MAKE) clean
	rm -f havp *.o
