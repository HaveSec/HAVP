CFLAGS=@CFLAGS@
LDFLAGS=@LDFLAGS@ @SCANNERLIB@
DEFINES=@DEFS@
prefix=@prefix@
exec_prefix=@exec_prefix@
sbindir=@sbindir@
etcdir=@sysconfdir@
INSTALL=../install-sh

OBJECTS = helper.o logfile.o scannerhandler.o connectiontobrowser.o genericscanner.o \
          httphandler.o params.o sockethandler.o connectiontohttp.o havp.o proxyhandler.o \
          utils.o whitelist.o scanners/avgscanner.o scanners/f-protscanner.o \
          scanners/kasperskyscanner.o scanners/nod32scanner.o scanners/clamdscanner.o \
	  scanners/sophiescanner.o @SCANNEROBJECT@

all: 	havp

havp: $(OBJECTS)
	$(CXX) -Wall -I. -I.. $(CFLAGS) -o havp $(OBJECTS) $(LDFLAGS)

install: all
	$(INSTALL) -d $(sbindir)
	$(INSTALL) -s -m 755 havp $(sbindir)/havp
	$(INSTALL) -d -m 755 /var/log/havp/
	$(INSTALL) -d -m 755 /var/tmp/havp/
	$(INSTALL) -d -m 755 /var/run/havp/
	$(INSTALL) -d /etc/init.d
	$(INSTALL) -m 755 ../etc/init.d/havp /etc/init.d/
	$(INSTALL) -m 644 ../etc/havp/havp.config $(etcdir)/havp/havp.config.default
	@if [ ! -f $(etcdir)/havp/havp.config ]; then \
		$(INSTALL) -m 644 ../etc/havp/havp.config $(etcdir)/havp/havp.config; \
	else \
		../update-conf $(etcdir)/havp/havp.config; \
	fi
	@if [ ! -f $(etcdir)/havp/whitelist ]; then \
		$(INSTALL) -m 644 ../etc/havp/whitelist $(etcdir)/havp/whitelist; \
	fi
	@if [ ! -f $(etcdir)/havp/blacklist ]; then \
		$(INSTALL) -m 644 ../etc/havp/blacklist $(etcdir)/havp/blacklist; \
	fi
	cp -r ../etc/havp/templates $(etcdir)/havp
	chmod -R a+rX $(etcdir)/havp/templates
	@echo ""
	@echo "Remember to give correct permissions:"
	@echo " chown <havpuser> /var/tmp/havp (after mounting if needed)"
	@echo " chown <havpuser> /var/log/havp"
	@echo " chown <havpuser> /var/run/havp"
	@echo ""

%.o:	%.cpp %.h
	$(CXX) -Wall $(DEFINES) -I. -I.. $(CFLAGS) -c $< -o $@

clean:
	-rm -f havp $(OBJECTS)

